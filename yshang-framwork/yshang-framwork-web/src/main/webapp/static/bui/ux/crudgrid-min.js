define("bui/ux/crudgrid",["bui/common","bui/grid","bui/form","bui/data","bui/overlay","bui/extensions/treegrid"],function(d){var g=d("bui/common"),a=d("bui/grid"),e=d("bui/data"),f=d("bui/extensions/treegrid"),c=d("bui/form");function b(h){b.superclass.constructor.call(this,h);this._init()}b.ATTRS={gridType:{value:"Grid"},pkColumn:{value:"id"},entityName:{},autoSearch:{value:true},gridId:{value:"grid"},addOrUpdateFormId:{value:"addOrUpdateForm"},searchFormId:{value:"searchForm"},searchBtnId:{value:"btnSearch"},searchFormCfg:{value:{}},gridCfg:{},columns:{},searchForm:{},grid:{},storeCfg:{},store:{},storeUrl:{value:""},addUrl:{value:""},updateUrl:{value:""},removeUrl:{value:""},dialogCfg:{},dialogContentId:{},addOrUpdatedialog:{},addOrUpdateFormId:{value:"addOrUpdateForm"},addOrUpdateForm:{},addOrUpdateFormCfg:{},appendTbarItems:{value:[]},addBtn:{value:{text:'<i class="icon-plus icon-white"></i>新建',btnCls:"button button-success",handler:null}},showAddBtn:{value:true},showUpdateBtn:{value:true},removeBtn:{value:{text:'<i class="icon-remove icon-white"></i>删除',btnCls:"button button-danger",handler:null}},showRemoveBtn:{value:true},saveType:{value:"add"},showRemoveOperation:{value:""},operationColumnCfg:{},showOperationColumn:{value:true},operationColumnRenderer:{},operationColumn:{value:""},gridPlugins:{value:[a.Plugins.CheckSelection,a.Plugins.AutoFit,a.Plugins.GridMenu]},pagingBar:{value:true},events:{value:["beforeAddShow","beforeUpdateShow","beforeAddOrUpdateSubmit"]}};g.extend(b,g.Base);g.augment(b,{_init:function(){var h=this;h._initStore();h._initSearchForm();h._initStoreEvent();h._initOperationColumn();h._initGrid();h._initEvent();h._initData();h._initAddOrUpdateForm();h._initAddOrUpdatedialog()},_initEvent:function(){this._initDomEvent();this._initSearchFormEvent();this._initGridEvent()},_initDomEvent:function(){var h=this,j=h.get("searchBtnId"),i=h.get("searchForm");$("#"+j).on("click",function(k){k.preventDefault();i.valid();if(i.isValid()){h.load(true)}})},_initSearchForm:function(){var h=this,i=h.get("form");if(!i){var j=g.merge(h.get("searchFormCfg"),{srcNode:"#"+h.get("searchFormId")});form=new c.HForm(j);form.render();h.set("searchForm",form)}},_initStore:function(){var i=this,l=i.get("gridType"),h=i.get("pkColumn"),k=i.get("store");if(!k){var j={url:i.get("storeUrl"),proxy:{save:{addUrl:i.get("addUrl"),updateUrl:i.get("updateUrl"),removeUrl:i.get("removeUrl")},method:"POST"},root:"content",totalProperty:"totalElements",pageSize:15,sortInfo:{field:h,direction:"DESC"},autoLoad:false,autoSync:true,remoteSort:true};var m=i.get("storeCfg");if(m){j=g.merge(j,m)}if(l=="TreeGrid"){k=new e.TreeStore(j)}else{k=new e.Store(j)}i.set("store",k)}},_initSearchFormEvent:function(){},_initOperationColumn:function(){var o=this,h=o.get("showOperationColumn"),i=o.get("operationColumnRenderer");if(h){var q=o.get("showRemoveBtn"),k=o.get("showUpdateBtn"),l=o.get("showRemoveOperation"),m=o.get("operationColumnCfg"),n={title:"操作",dataIndex:"",sortable:false};if(m){n=g.merge(n,m)}var p=new a.Column(n);var j="";if(k){j+='<span class="grid-command" title="编辑"><i class="icon-edit btn-edit"></i></span>'}if((l.length==0&&q)||l){j+='<span class="grid-command" title="删除"><i class="icon-trash btn-del"></i></span>'}if(j.length>0||i){p.set("renderer",function(s,t){var r="";if(i){r=i(s,t)}return r+j});o.set("operationColumn",p)}}},_initGrid:function(){var q=this,h=q.get("grid");if(!h){var n=q.get("gridCfg"),s=q.get("store"),w=q.get("gridId"),y=q.get("showAddBtn"),p=q.get("showRemoveBtn"),x=q.get("showOperationColumn"),t=q.get("operationColumn"),l=q.get("columns"),k=q.get("appendTbarItems"),i=q.get("gridType"),o=q.get("gridPlugins");items=[];if(y){var v=function(){q.add(q)};var m=q.get("addBtn");if(m&&m.handler==null){m.handler=v}items.push(m)}if(p){var z=function(){q.del(q)};var u=q.get("removeBtn");if(u&&u.handler==null){u.handler=z}items.push(u)}if(k&&k.length>0){$.each(k,function(A,B){if(B){items.push(B)}})}if(x&&t){l.push(t)}var j=null;if(items&&items.length>0){j={items:items}}var r={render:"#"+w,columns:l,store:s,tbar:j,width:"100%",loadMask:true,plugins:o,bbar:{pagingBar:q.get("pagingBar")}};r=g.merge(r,n);if(i=="TreeGrid"){r.bbar.pagingBar=false;h=new f(r)}else{h=new a.Grid(r)}q.set("grid",h)}h.render()},_initGridEvent:function(){var h=this,i=h.get("grid");i.on("cellclick",function(n){var l=h.get("showUpdateBtn"),k=h.get("showRemoveBtn");var m=$(n.domTarget);if(m.hasClass("btn-del")){var j=n.record;h.delItems([j])}else{if(m.hasClass("btn-edit")){var j=n.record;h.edit(j)}}})},_initData:function(){var h=this,i=h.get("autoSearch");if(i){h.load(true)}},_initStoreEvent:function(){var h=this,i=h.get("store");i.on("exception",function(j){g.Message.Alert(j.error)})},_initAddOrUpdateForm:function(){var h=this,i=h.get("addOrUpdateForm");if(!i){var j=g.merge(h.get("addOrUpdateFormCfg"),{srcNode:"#"+h.get("addOrUpdateFormId"),initRecord:{}});i=new c.HForm(j);i.render();h.set("addOrUpdateForm",i)}},_initAddOrUpdatedialog:function(){var n=this,h=n.get("dialogCfg"),r=n.get("gridType"),i=n.get("addOrUpdatedialog");if(!i){var m=n.get("dialogContentId"),l=n.get("addOrUpdateForm"),o=n.get("entityName"),p=n.get("store");var j=function(){var t=n;l.valid();if(l.isValid()){var s=n.fire("beforeAddOrUpdateSubmit",w,l);if(typeof(s)!="undefined"&&!s){return false}var x=l.serializeToObject();var v=function(y){if(y.success){n._resetForm(l);i.close()}else{g.Message.Alert("操作失败:"+y.msg,"warning")}};var w=t.get("saveType");if(r=="TreeGrid"){var u=null;if(w=="add"){u=n.get("addUrl")}else{u=n.get("updateUrl")}$.post(u,x,function(y){v(y);if(y.success){p.load()}},"json")}else{p.save(w,x,v)}}};var q=function(){n._resetForm(l)};var k={title:"新增"+o,contentId:m,success:j,cancel:q};if(h){k=g.merge(k,h)}i=new g.Overlay.Dialog(k);i.on("show",function(){l.clearErrors()});n.set("addOrUpdatedialog",i)}},_resetForm:function(i){var h=i.getFields();g.each(h,function(j){if(j.get("disabled")){j.enable()}});i.reset()},del:function(){this._del(this)},_del:function(h){grid=h.get("grid");var i=grid.getSelection();h.delItems(i)},add:function(){this._add(this)},_add:function(k){var i=this,m=k.get("addOrUpdatedialog"),j=i.get("addOrUpdateForm"),l=k.get("entityName");m.set("title","新增"+l);k.set("saveType","add");var h=k.fire("beforeAddShow",m,j);if(typeof(h)=="undefined"||h){m.show()}},edit:function(k){var i=this,n=i.get("addOrUpdatedialog"),l=i.get("addOrUpdateForm"),m=i.get("entityName");i.set("saveType","update");var j=i.get("saveType");n.set("title","修改"+m);l.setRecord(k);var h=i.fire("beforeUpdateShow",n,l,k);if(typeof(h)=="undefined"||h){n.show()}},delItems:function(l){var i=this,k=i.get("gridType"),j=i.get("store"),h=i.get("pkColumn"),m=[];g.each(l,function(n){m.push(n[h])});if(m.length){if(k=="TreeGrid"){g.Message.Confirm("确认要删除选中的记录么？",function(){var n=new Object();n[h+"s[]"]=m;$.post(i.get("removeUrl"),n,function(o){if(o.success){j.load()}else{g.Message.Alert("操作失败:"+o.msg,"warning")}},"json")},"question")}else{g.Message.Confirm("确认要删除选中的记录么？",function(){var n=new Object();n[h+"s"]=m;j.save("remove",n,function(o){if(!o.success){g.Message.Alert("操作失败:"+o.msg,"warning")}})},"question")}}},load:function(k){var h=this,j=h.get("searchForm"),i=h.get("store"),l=j.serializeToObject();if(k){l.start=0;l.pageIndex=0;i.setInternal("lastParams",{shared:false,value:{}})}i.load(l)}});b.createLink=function(h){var i='<span class="page-action grid-command" data-id="{id}" data-href="{href}" title="{title}">{text}</span>';return g.substitute(i,h)};return b});